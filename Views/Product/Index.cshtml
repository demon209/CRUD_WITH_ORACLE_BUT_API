<h2>Trang qu·∫£n l√Ω s·∫£n ph·∫©m</h2>

<div class="mb-3 d-flex flex-column flex-sm-row gap-2">
    <input type="text" id="searchBox" class="form-control"
        placeholder="T√¨m theo t√™n s·∫£n ph·∫©m, lo·∫°i s·∫£n ph·∫©m ho·∫∑c id,.." />
    <button class="btn btn-success" onclick="openAddForm()">Th√™m th√¥ng tin s·∫£n ph·∫©m m·ªõi</button>
</div>

<h2>Danh s√°ch s·∫£n ph·∫©m</h2>
<div class="row align-items-center mb-3">
    <div class="col-12 col-md-8 mb-3 mb-md-0">
        <div class="d-flex justify-content-between align-items-center">
            <!-- Checkbox b√™n tr√°i -->
            <div class="form-check m-0">
                <input class="form-check-input" type="checkbox" value="true" id="onlyAvailableCheckbox">
                <label class="form-check-label text-success" for="onlyAvailableCheckbox">
                    Ch·ªâ hi·ªán d·ªãch v·ª• ‚úÖ
                </label>
            </div>

            <!-- N√∫t "L·ªçc" b√™n ph·∫£i -->
            <button class="btn btn-primary" id="filterButton">L·ªçc</button>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered align-middle text-center">
        <thead class="table-light">
            <tr>
                <th>Product ID</th>
                <th>Product Name</th>
                <th>Product Category</th>
                <th>Product Price</th>
                <th>Product Stock</th>
                <th>Product Type</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="product-body">
            <tr>
                <td colspan="7">‚è≥ ƒêang t·∫£i danh s√°ch...</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-end mt-2" id="pagination"></div>

<!-- Modal Th√™m/S·ª≠a -->
<div id="productModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="productForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">S·∫£n ph·∫©m</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="productId" />

                    <div class="mb-2">
                        <label for="productName" class="form-label">T√™n s·∫£n ph·∫©m</label>
                        <input type="text" class="form-control" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
                            required />
                    </div>

                    <div class="mb-2">
                        <label for="productCategory" class="form-label">Danh m·ª•c s·∫£n ph·∫©m</label>
                        <input type="text" class="form-control" id="productCategory" placeholder="Nh·∫≠p danh m·ª•c"
                            required />
                    </div>

                    <div class="mb-2">
                        <label for="productPrice" class="form-label">Gi√° s·∫£n ph·∫©m</label>
                        <input type="number" class="form-control" id="productPrice" placeholder="Nh·∫≠p gi√°" required />
                    </div>

                    <div class="mb-2">
                        <label for="productStock" class="form-label">T·ªìn kho</label>
                        <input type="number" class="form-control" id="productStock" placeholder="S·ªë l∆∞·ª£ng t·ªìn kho"
                            required />
                    </div>

                    <div class="mb-2">
                        <label for="productType" class="form-label">Lo·∫°i s·∫£n ph·∫©m</label>
                        <input type="text" class="form-control" id="productType" placeholder="Nh·∫≠p lo·∫°i s·∫£n ph·∫©m"
                            required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPage = 1;
        const modal = new bootstrap.Modal(document.getElementById('productModal'));

        function loadProducts(keyword = "", page = 1) {
            currentPage = page;
            const onlyAvailable = $('#onlyAvailableCheckbox').is(':checked');
            let apiUrl = `/api/products/search?keyword=${encodeURIComponent(keyword)}&page=${page}`;
            if (onlyAvailable) apiUrl += `&onlyAvailable=true`;
            $("#product-body").html('<tr><td colspan="7">‚è≥ ƒêang t·∫£i...</td></tr>');

            $.get(apiUrl, function (data) {
                const tbody = $("#product-body");
                tbody.empty();

                if (data.data.length === 0) {
                    tbody.append(`<tr><td colspan="7" class="text-danger">Kh√¥ng c√≥ s·∫£n ph·∫©m.<a href="/Sanpham" class="btn btn-secondary">‚¨Ö Quay l·∫°i</a></td></tr>`);
                    $("#pagination").empty();
                    return;
                }

                data.data.forEach(c => {
                    tbody.append(`
                        <tr>
                            <td>${c.productId}</td>
                            <td>${c.productName}</td>
                            <td>${c.productCategory}</td>
                            <td>${c.productPrice}</td>
                            <td>${c.productStock}</td>
                            <td>${c.productType}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="openEditForm(${c.productId})">‚úèÔ∏è S·ª≠a</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${c.productId})">‚ùå X√≥a</button>
                            </td>
                        </tr>`);
                });

                renderPagination(data.currentPage, data.totalPages);
            });
        }

        function renderPagination(current, total) {
            const container = $("#pagination");
            container.empty();
            for (let i = 1; i <= total; i++) {
                const btn = `<button onclick="loadProducts($('#searchBox').val(), ${i})"
                    class="btn btn-sm ${i === current ? 'btn-primary' : 'btn-outline-primary'} mx-1">${i}</button>`;
                container.append(btn);
            }
        }

        function openAddForm() {
            $("#modalTitle").text("üôã Th√™m s·∫£n ph·∫©m m·ªõi");
            $("#productForm")[0].reset();
            $("#productId").val('');
            modal.show();
        }

        function openEditForm(id) {
            $.get(`/api/products/${id}`, function (data) {
                $("#modalTitle").text("üë®‚Äçüîß S·ª≠a s·∫£n ph·∫©m");
                $("#productId").val(data.productId);
                $("#productName").val(data.productName);
                $("#productCategory").val(data.productCategory);
                $("#productPrice").val(data.productPrice);
                $("#productStock").val(data.productStock);
                $("#productType").val(data.productType);
                modal.show();
            });
        }

        $("#productForm").on("submit", function (e) {
            e.preventDefault();

            const id = $("#productId").val();
            const method = id ? "PUT" : "POST";
            const url = id ? `/api/products/${id}` : `/api/products`;

            const product = {
                productName: $("#productName").val(),
                productCategory: $("#productCategory").val(),
                productPrice: $("#productPrice").val(),
                productStock: $("#productStock").val(),
                productType: $("#productType").val()
            };

            fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(product)
            })
                .then(res => res.json())
                .then(data => {
                    modal.hide();
                    Swal.fire("‚úÖ Th√†nh c√¥ng", data.message || "Th√†nh c√¥ng", "success");
                    loadProducts($("#searchBox").val(), currentPage);
                })
                .catch(err => Swal.fire("‚ùå L·ªói", "Kh√¥ng th·ªÉ l∆∞u s·∫£n ph·∫©m", "error"));
        });

        function deleteProduct(id) {
            Swal.fire({
                title: 'B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/products/${id}`, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            Swal.fire("‚úÖ ƒê√£ x√≥a", data.message, "success");
                            loadProducts($("#searchBox").val(), currentPage);
                        })
                        .catch(() => Swal.fire("‚ùå L·ªói", "Kh√¥ng th·ªÉ x√≥a", "error"));
                }
            });
        }

        $(document).ready(function () {
            loadProducts();

            $("#searchBox").on("input", function () {
                loadProducts($(this).val(), 1);
            });
            $("#filterButton").on("click", function () {
                loadProducts($("#searchBox").val(), 1);
            });
        });
    </script>
}
